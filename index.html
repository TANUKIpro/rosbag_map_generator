<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ROS Bag Map Generator</title>
    <link rel="stylesheet" href="styles/main.css" />
  </head>
  <body>
    <header class="app-header">
      <h1>ROS Bag Map Generator</h1>
      <p class="subtitle">ローカルbagから2D占有グリッド地図を生成</p>
    </header>
    <main class="layout">
      <aside class="sidebar">
        <section class="panel">
          <h2>ファイル</h2>
          <div id="dropzone" class="dropzone" tabindex="0">
            <p><strong>ファイルをドロップ</strong> またはクリックして選択</p>
            <p class="hint">対応: .bag (ROS1) / 将来: .mcap</p>
          </div>
          <div id="file-info" class="file-info hidden"></div>
        </section>
        <section class="panel">
          <h2>トピック選択</h2>
          <div class="topic-field">
            <label for="scan-topic">/scan</label>
            <select id="scan-topic"></select>
          </div>
          <div class="topic-field">
            <label for="odom-topic">/odom</label>
            <select id="odom-topic"></select>
          </div>
          <div class="topic-field">
            <label for="tf-topic">/tf</label>
            <select id="tf-topic"></select>
          </div>
          <button id="apply-topics" class="primary" disabled>トピックを確定</button>
        </section>
      </aside>
      <section class="workspace">
        <div class="toolbar">
          <div class="controls">
            <button id="play" class="control" disabled>▶ 再生</button>
            <button id="pause" class="control" disabled>⏸ 一時停止</button>
            <button id="stop" class="control" disabled>⏹ 停止</button>
            <label class="control">
              速度
              <select id="playback-speed" disabled>
                <option value="0.5">0.5×</option>
                <option value="1" selected>1×</option>
                <option value="2">2×</option>
                <option value="4">4×</option>
              </select>
            </label>
            <button id="mark-start" class="control" disabled>区間開始</button>
            <button id="mark-end" class="control" disabled>区間終了</button>
          </div>
          <div class="exports">
            <button id="export-now" class="primary" disabled>今すぐエクスポート</button>
            <button id="export-range" class="secondary" disabled>区間で再生成→エクスポート</button>
          </div>
        </div>
        <div class="canvas-container">
          <canvas id="map-canvas" width="800" height="800" role="img" aria-label="Occupancy grid preview"></canvas>
          <div class="map-controls">
            <h3>マップ設定</h3>
            <label class="control-group">
              <span>解像度 (m)</span>
              <input id="resolution" type="number" value="0.05" step="0.01" min="0.01" />
            </label>
            <label class="control-group">
              <span>マップ幅 (m)</span>
              <input id="map-width" type="number" value="50" step="1" min="5" />
            </label>
            <label class="control-group">
              <span>マップ高さ (m)</span>
              <input id="map-height" type="number" value="50" step="1" min="5" />
            </label>
            <label class="control-group">
              <span>スキャン間引き</span>
              <input id="downsample" type="number" value="1" step="1" min="1" />
            </label>
            <button id="apply-config" class="secondary">設定を送信</button>
            <div class="zoom-info">
              <span>ズーム: <span id="zoom-level">100%</span></span>
            </div>
          </div>
        </div>
        <div class="status-bar">
          <div>時刻: <span id="timestamp">--:--:--.--</span></div>
          <div>フレーム: <span id="frame-info">-/-</span></div>
          <div>FPS: <span id="fps">0</span></div>
          <div>WASM: <span id="wasm-time">0 ms</span></div>
          <div>メモリ: <span id="memory">0 MB</span></div>
        </div>
      </section>
    </main>

    <!-- Debug Panel -->
    <div id="debug-panel" class="debug-panel">
      <div class="debug-header">
        <h3>🔍 デバッグパネル</h3>
        <button id="debug-toggle" class="debug-toggle">最小化</button>
        <button id="debug-clear" class="debug-clear">クリア</button>
      </div>
      <div class="debug-content">
        <div class="debug-section">
          <h4>現在の状態</h4>
          <div class="debug-info">
            <div>ファイル: <span id="debug-file">なし</span></div>
            <div>トピック (scan): <span id="debug-topic-scan">未設定</span></div>
            <div>トピック (odom): <span id="debug-topic-odom">未設定</span></div>
            <div>トピック (tf): <span id="debug-topic-tf">未設定</span></div>
            <div>GRID_FRAME受信数: <span id="debug-frame-count">0</span></div>
            <div>最終ImageBitmap: <span id="debug-imagebitmap">なし</span></div>
          </div>
        </div>
        <div class="debug-section">
          <h4>メッセージ履歴 (最新10件)</h4>
          <div id="debug-messages" class="debug-messages"></div>
        </div>
        <div class="debug-section">
          <h4>Worker内部ログ (最新5件)</h4>
          <div id="debug-worker-logs" class="debug-messages"></div>
        </div>
      </div>
    </div>

    <output id="toast" class="toast" role="status" aria-live="polite"></output>
    <script type="module" src="src/main.js"></script>
  </body>
</html>
